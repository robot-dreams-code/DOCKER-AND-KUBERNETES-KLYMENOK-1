#add ConfigMap and apply changes
kubectl create namespace lesson07
kubectl create configmap web-config --from-file=./web-config.yaml
kubectl apply -f web-config.yaml

kubectl apply -f redis-deployment.yaml
kubectl apply -f redis-service.yaml

kubectl apply -f app-deployment.yaml
kubectl apply -f app-service.yaml

#Change values  in ConfigMap and check Pods :
##Change APP_NAME, reapply 
kubectl apply -f web-config.yaml
kubectl rollout restart deployment course-app

##See how the pods change in real time
kubectl get pods -n lesson07 --watch 

##See the  changes to the deployment
kubectl describe deployment course-app -n lesson07

##Update container image and check rollout 
pushed new container image version (1.0 vs 1.1)
kubectl apply -f app-deployment.yaml
###check rollout 
kubectl rollout status deployment/course-app

#RollingUpdate (maxUnavailable, maxSurge) vs Replace
##Recreate - all down, then gradually up
Waiting for deployment "course-app" rollout to finish: 0 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 1 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 3 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 15 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 19 of 20 updated replicas are available...
deployment "course-app" successfully rolled out


##RollingUpdate(maxUnavailable=1, maxSurge=1)(replicas=20) - one new up, one old down
Waiting for deployment "course-app" rollout to finish: 4 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 8 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 19 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 19 of 20 updated replicas are available...
deployment "course-app" successfully rolled out

##RollingUpdate(maxUnavailable=1, maxSurge=5)(replicas=20) - up to 5 new up, then by 1 old down
Waiting for deployment "course-app" rollout to finish: 6 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 15 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 19 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 6 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 19 of 20 updated replicas are available...
deployment "course-app" successfully rolled out


##RollingUpdate(maxUnavailable=15, maxSurge=10)(replicas=20) - 15 old down, then new are up
Waiting for deployment "course-app" rollout to finish: 5 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 5 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 8 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 14 of 20 updated replicas are available...
Waiting for deployment "course-app" rollout to finish: 19 of 20 updated replicas are available...
deployment "course-app" successfully rolled out


##RollingUpdate(maxUnavailable=10%, maxSurge=10%)(replicas=20) - most 2 old pods are down, at most 2 new pods above the desired count are created
Waiting for deployment "course-app" rollout to finish: 8 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 14 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 19 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 2 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 19 of 20 updated replicas are available...
deployment "course-app" successfully rolled out

##RollingUpdate(maxUnavailable=25%, maxSurge=25%)(replicas=20) up to 5 pods can be unavailable and 5 extra pods can be created
Waiting for deployment "course-app" rollout to finish: 12 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 17 out of 20 new replicas have been updated...
Waiting for deployment "course-app" rollout to finish: 5 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 3 old replicas are pending termination...
Waiting for deployment "course-app" rollout to finish: 1 old replicas are pending termination...
deployment "course-app" successfully rolled out

#shutting down
kubectl scale deployment course-app --replicas=0