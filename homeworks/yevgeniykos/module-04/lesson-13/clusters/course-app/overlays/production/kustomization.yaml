apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - HPA.yaml
  - ../../base/
  - ../dragonfly.yaml
patches:

  - target:
      kind: HorizontalPodAutoscaler   
    patch: |
        - op: replace
          path: /spec/scaleTargetRef/name
          value: course-app-production

  - target:
      kind: Service   
    patch: |
        - op: replace
          path: /metadata/namespace
          value: production
          
        - op: replace
          path: /metadata/labels/app
          value: course-app-production

  - target:
      kind: Ingress   
    patch: |
        - op: replace
          path: /metadata/namespace
          value: production

  - target:
      kind: Namespace    
    patch: |
        - op: replace
          path: /metadata
          value:
            name: production

  - target:
      kind: Deployment    
    patch: |
        - op: replace
          path: /spec/template/spec/containers/0/env/1/value
          value: "Welcome to the Production Environment"

        - op: replace
          path: /spec/template/spec/containers/0/env/2/value
          value: dragonfly

        - op: replace
          path: /spec/template/spec/containers/0/env/3/value
          value: "dragonfly-app.production.svc.cluster.local:6379/0"

        - op: replace
          path: /spec/template/spec/containers/0/resources/requests/cpu
          value: "100m"

        - op: replace
          path: /spec/template/spec/containers/0/resources/requests/memory
          value: "512Mi"

        - op: replace
          path: /spec/template/spec/containers/0/resources/limits/cpu
          value: "1"

        - op: replace
          path: /spec/template/spec/containers/0/resources/limits/memory
          value: "1Gi"       
    
        - op: replace
          path: /spec/replicas
          value: 2

        - op: add
          path: /metadata/namespace
          value: production
          
        - op: add
          path: /metadata/name
          value: course-app-production

  - target:
      kind: Dragonfly
    patch: |
        - op: replace
          path: /spec
          value: 
            replicas: 3

        - op: replace
          path: /metadata
          value:
            namespace: production
            name: dragonfly-prod